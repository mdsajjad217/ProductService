version: "3.9"

services:
  # -----------------------------
  # Apache Kafka (KRaft Mode)
  # -----------------------------
  kafka:
    image: apache/kafka:latest
    container_name: kafka
    ports:
      - "9097:9097"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: 'broker,controller'
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka:9093'
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      KAFKA_LISTENERS: 'PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9097'
      # FIX: Advertised as localhost so Offset Explorer can connect
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka:9092,EXTERNAL://localhost:9097'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT'
      KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
    networks:
      - app-network

  # -----------------------------
  # Kafka Topic Initializer
  # -----------------------------
  kafka-init:
    image: apache/kafka:latest
    container_name: kafka-init
    depends_on:
      - kafka
    entrypoint: [ '/bin/sh', '-c' ]
    command: |
      "
      # Wait for Kafka to be ready
      /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 --list
      echo 'Creating kafka topics...'
      /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 --create --if-not-exists --topic order-created --replication-factor 1 --partitions 1
      echo 'Successfully created topics'
      "
    networks:
      - app-network

  # -----------------------------
  # Product Service
  # -----------------------------
  productservice:
    build: ./ProductService
    container_name: productservice
    depends_on:
      kafka-init:
        condition: service_completed_successfully
    ports:
      - "8080:8080"
    environment:
      ASPNETCORE_URLS: "http://0.0.0.0:8080"
      ConnectionStrings__ProductDb: "Server=host.docker.internal,1433;Database=ProductService;User Id=sa;Password=123456;TrustServerCertificate=True;"
      Kafka__BootstrapServers: "kafka:9092"
      Kafka__Consumer__GroupId: "order-created-group"
      Kafka__Consumer__AutoOffsetReset: "Earliest"
      Kafka__Consumer__EnableAutoCommit: "false"
    networks:
      - app-network

  # -----------------------------
  # Order Service
  # -----------------------------
  orderservice:
    build: ./OrderService
    container_name: orderservice
    depends_on:
      kafka-init:
        condition: service_completed_successfully
    ports:
      - "8081:8081"
    environment:
      ASPNETCORE_URLS: "http://0.0.0.0:8081"
      ConnectionStrings__OrderDb: "Server=host.docker.internal,1433;Database=OrderService;User Id=sa;Password=123456;TrustServerCertificate=True;"
      Kafka__BootstrapServers: "kafka:9092"
      Kafka__Acks: "All"
      Kafka__EnableIdempotence: "true"
      Kafka__MessageSendMaxRetries: "3"
      Kafka__RetryBackoffMs: "100"
      Kafka__LingerMs: "5"
    networks:
      - app-network

networks:
  app-network:
    driver: bridge